{{ define "postForm" }}
<html>
<body onload="document.forms[0].submit()">
<form action="{{.Acs}}" method="POST">
{{if .Samlresponse }}
<input type="hidden" name="SAMLResponse" value="{{.Samlresponse}}" />
{{end}}
{{if .Samlrequest }}
<input type="hidden" name="SAMLRequest" value="{{.Samlrequest}}" />
{{end}}
{{if .RelayState }}
<input type="hidden" name="RelayState" value="{{.RelayState}}" />
{{end}}
</form>
</body>
</html>
{{ end }}

{{ define "SLOForm" }}
<html>
<body>
<pre>
{{.SLOStatus}}
</pre>
<input type=button value=submit onClick="window.location='{{.Acs}}'">
</body>
</html>
{{ end }}

{{ define "attributeReleaseForm" }}
<!DOCTYPE html>
<html>
<head>
    <title>
        attributeRelease
    </title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <link type="text/css" rel="stylesheet" href="https://wayf.wayf.dk/wayf_new.css" media="all" />
    <style>
        body {
            font: 13px/18px Helvetica, Arial, sans-serif;
        }

        input {
            margin: 5px 5px 5px 0;
            padding: 5px;
            font: 15px/18px Helvetica, Arial, sans-serif;
        }

        div,
        p {
            margin: 1em 0;
        }

        div.r {
            text-align: right;
        }

        .prevattrs > ul {
            list-style: inherit;
        }

        .prevattrs ul.rm {
            list-style: none;
        }

        span.rm {
            content: 'X';
            color: orange;
        }

        .prevattrs ul.rm li::before {
            content: 'X';
            color: orange;
            display: inline-block;
            width: 1em;
            margin-left: -1em
        }

        @media only screen and (max-width: 800px) {
            span.input {
                display: block;
            }
        }
    </style>
    <meta name="robots" content="noindex, nofollow" />
    <script type="text/javascript" src="https://wayf.wayf.dk/mustache.min.js"></script>

</head>

<body style="display: none;">
    <div id="header">
        <a id="wayflogo" href="http://www.wayf.dk" title="WAYF homepage" target="_blank">
        WAYF
    </a>
        <div id="langs"></div>
        <a id="deiclogo" href="http://www.deic.dk" title="DeiC homepage" target="_blank">
      DeiC
    </a>
    </div>
    <div id="subheader">
    </div>
    <div id="sectionouter">
        <div id="section">
            <div id=error>
            </div>
            <div id=content>
            </div>
        </div>
    </div>
    <div style="clear:both;">
    </div>
    <div id="footer">
    </div>
    <!-- div id footer -->
    <br />
{{if .WsFed}}
<form id="samlform" action="{{.Acs}}" method="POST">
<input type="hidden" name="wa" value="wsignin1.0">
<input type="hidden" name="wresult" value="{{.Samlresponse}}" />
{{if .RelayState }}
<input type="hidden" name="wctx" value="{{.RelayState}}" />
{{end}}
{{else}}
<form id="samlform" action="{{.Acs}}" method="POST">
<input type="hidden" name="SAMLResponse" value="{{.Samlresponse}}" />
{{if .RelayState }}
<input type="hidden" name="RelayState" value="{{.RelayState}}" />
{{end}}
</form>
{{end}}
    <script type="text/javascript" src="https://wayf.wayf.dk//dsar5.js"></script>
    <script type="text/javascript">
        var ard = {{.Ard}}
        var lang = 'da'
        ar.dispatch(lang, data, ard);
    </script>
</body>
</html>
{{ end }}

{{ define "testSPForm" }}
<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style>
    :root {
        --brand-color:#66b340;
    }

    body
    {
        width: 900px;
        margin: auto;
        padding: 10px;
        padding-top: 30px;
        font-size: 14pt;
        line-height: 140%;
        font-family: Arial, Helvetica, sans-serif;
        color: var(--brand-color);
    }

    .test
    {
        border: thick orange dashed;
        box-sizing: border-box;
    }

    h1, h2
    {
        padding: 20px;
        background-color: var(--brand-color);
        color: white;
        border-radius: 3px;
    }

    pre
    {
        padding: 12px;
        background-color: #CCC;
        border-radius: 3px;
    }

    code
    {
        font-size: 1.3em;
        color: rgb(200, 0, 0);
        padding: 2px;
        line-height: normal;
    }

    .button
    {
        font-size: large;
        background-color: var(--brand-color);
        border: none;
        color: white;
        padding: 10px 20px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        cursor: pointer;
        border-radius: 5px;
        margin: 5px;
    }

    .button2 { padding: 5px 20px; }

    table.attrValues td
    {
        padding: 5px;
        vertical-align: top;
        border-bottom: 1px solid var(--brand-color);
    }

    tr:nth-child(even) { background-color: #f2f2f2; }

    div.debug
    {
        border-radius: 3px;
        border: thin solid  var(--brand-color);
        padding: 10px 3px;
        margin: 10px 0;
    }
</style>
<script>
function vvpmss() {
    var url = 'https://wayf.wayf.dk/vvpmss?origin=' + window.location.origin + '&idplist=' + document.getElementById("scopedidp").value
    var ifrm = document.createElement("iframe")
    ifrm.setAttribute("src", url)
    ifrm.style.width = "0";
    ifrm.style.height = "0";
    document.body.appendChild(ifrm)
    return true

//     var oReq = new XMLHttpRequest();
//     oReq.withCredentials = true;
//     oReq.open("GET", url, false);
//     oReq.send();
//     return true;
}

function checkForHybrid() {
    var url = 'https://wayf.wayf.dk/vvpmss'
    var oReq = new XMLHttpRequest()
    oReq.withCredentials = true
    oReq.onloadend = function() {}
    oReq.open("GET", url, false)
    try {
     oReq.send()
    } catch (e) {
    }
    if (oReq.status == 0) { alert("Could not contact the Hybrid test environment. Please restart the browser or delete all session cookies.") }
    else { alert("OK - using the "+oReq.response+" environment. Go to the service(s) you want to test now.") }
}

function haproxy(env) {
    var cookiepairs = {qa: [["birkid", "birk-qa"], ["nemloginid", "nemlogin-qa"], ["wayfid", "wayf-qa"], ["kribid", "krib-qa"], ["wayfsp2id", "wayfsp2-qa"]],
                       '07': [["birkid", "birk-07"], ["nemloginid", "nemlogin-03"], ["wayfid", "wayf-07"], ["kribid", "krib-01"], ["wayfsp2id", "wayfsp2-07"]],
                       '08': [["birkid", "birk-08"], ["nemloginid", "nemlogin-04"], ["wayfid", "wayf-08"], ["kribid", "krib-02"], ["wayfsp2id", "wayfsp2-08"]]
    }
    for (var i=0 ; i < cookiepairs[env].length ; i++) {
        var cp = cookiepairs[env][i]
        document.cookie = cp[0] + "=" + cp[1] + ";secure;domain=wayf.dk; SameSite=None"
    }
    checkForHybrid()
}

function setDebug() {
    var settings = ""
    var debuginput = window.document.querySelectorAll("#debug input")
    for (var i=0 ; i < debuginput.length ; i++) {
        if (debuginput[i].checked) {
            settings += debuginput[i].name+"="+debuginput[i].value+"&"
        }
    }
    document.cookie = "debug="+settings+";secure;domain=wayf.dk;path=/"
    getDebug()
}

function getDebug() {
    var cookieValue = document.cookie.match(/(?:(?:^|.*;\s*)debug\s*\=\s*([^;]*).*$)|^.*$/, "$1");
    if (cookieValue[1] != undefined) {
        p = cookieValue[1].split("&")
        for (var i = 0; i < p.length; i++) {
            if (!p[i]) continue;
            var kv = p[i].split("=")
            window.document.querySelector("#debug input[name='"+kv[0]+"'][value='"+kv[1]+"']").checked = true
        }
    }
}

</script>
</head>
<body>
<h1 id=title>WAYF test service</h1>
<div id=mindthegap></div>
<div id=details>
<form method=POST action="/">
<div class=debug>
<button type=submit name=login value=1 class=button>Login</button>
<input type="button" class=button onclick="location.href='https://wayf.wayf.dk/saml2/idp/SSOService2.php?wa=wsignin1.0&wtrealm=https://wayfsp.wayf.dk';" value="WS-Fed Passive Login" />
<br>
Request flags: <label><input type=checkbox name=isPassive value=1> isPassive</label>
<label><input type=checkbox name=forceAuthn value=1> forceAuthn</label>
<label><input type=checkbox name=persistent value=1> persistent nameID</label><br>
</div>
<div class=debug>
"Scoping" - first select one or more IdP(s), then select method<br>
<button type=submit name=ds value=1 class=button>DS</button>
IdP(s): <input type=text id=scopedidp name=scopedidp value="{{.ScopedIDP}}" size=75><br>
Method: <label><input type=radio name=scoping value="" checked> None</label>
<label><input type=radio name=scoping value=birk> BIRK</label>
<label><input type=radio name=scoping value=scoping> Scoping</label>
<label><input type=radio name=scoping value=param> Param</label>
<label><input type=radio name=scoping value=vvpmss onClick="return vvpmss();" > Vvpmss</label>
</div>
<div id=debug class=debug>Hybrid environment - dynamic "features" - sets a cookie that modifies the hybrid hub's normal behavior. For testing new features and responses to e.g. error conditions:<br>
<label title="Dumps SAML messages on server."><input type=checkbox name=trace value=1 onClick="return setDebug();"> trace SAML messages</label><br>
Hub -> IdP:<br>
Signature Algorithm:<label><input type=radio name=idpSigAlg value=sha512 onClick="return setDebug();"> sha512</label>
<label><input type=radio name=idpSigAlg value=sha256 onClick="return setDebug();"> sha256</label>
<label><input type=radio name=idpSigAlg value=sha1 onClick="return setDebug();"> sha1</label>
<label><input type=radio name=idpSigAlg value="" onClick="return setDebug();"> default</label>
<br>
<label title="Send RequesterID to IdP"><input type=checkbox name=wantRequesterID value=1 onClick="return setDebug();"> wantRequesterID</label>
<br>
Hub -> SP:<br>
Signature Algorithm:<label><input type=radio name=spSigAlg value=sha512 onClick="return setDebug();"> sha512</label>
<label><input type=radio name=spSigAlg value=sha256 onClick="return setDebug();"> sha256</label>
<label><input type=radio name=spSigAlg value=sha1 onClick="return setDebug();"> sha1</label>
<label><input type=radio name=spSigAlg value="" onClick="return setDebug();"> default</label>
<br>
<label><input type=checkbox name=encryptAssertion value=1 onClick="return setDebug();" title="Encrypts the assertion"> encryptAssertion</label>
<label title="Modifies the assertion after signing. Must give an error on the service provider."><input type=checkbox name=signingError value=1 onClick="return setDebug();"> signingError</label>
<label title="Introduces scoping error for eppn."><input type=checkbox name=scopingError value=1 onClick="return setDebug();"> scopingError</label>
</div>
<div class=debug>
<button type=button onClick="return haproxy('qa');" class="button">wayf-qa</button>
<button type=button onClick="return haproxy('07');" class="button">wayf-07</button>
<button type=button onClick="return haproxy('08');" class="button">wayf-08</button>
</div>
</div>
</form>
{{if .ResponsePP }}
    {{if eq .Protocol "LogoutResponse"}}
        <h2>Logout successful</h2>
    {{end}}
    {{if eq .Protocol "Response"}}
        <h2>Login successful</h2>
        <div class=debug>
        Scoping Errors: {{.Messages}}
        </div>

        <form action=/ method=POST>
        <button type=submit name=logout value=1  class=button>Logout</button>
        <a href="https://wayf.wayf.dk/saml2/idp/SingleLogoutService.php?wtrealm=https://wayfsp.wayf.dk&wa=wsignout1.0">WS-Fed logout</a>
        <input type=hidden name=response value="{{.ResponsePP}}">
        <input type=hidden name=issuer value="{{.Issuer}}">
        <input type=hidden name=destination value="{{.Destination}}">
        <input type=hidden name=external value="{{.External}}">
        </form>
        <table class=attrValues>
        {{range .AttrValues}}
        <tr>
        <td>{{.Name}} {{.FriendlyName}}{{if .Must}}*{{end}}</td>
        <td>{{range .Values}}{{.}}<br>{{end}}</td>
        </tr>
        {{end}}
        </table>
    {{end}}
    {{if eq .Protocol "LogoutRequest"}}
        <h2>LogoutRequest received</h2>
        <form action=/ method=POST>
        <button type=submit name=logoutresponse value=1  class=button>Send Logout Response</button>
        <input type=hidden name=response value="{{.ResponsePP}}">
        <input type=hidden name=issuer value="{{.Issuer}}">
        <input type=hidden name=destination value="{{.Destination}}">
        <input type=hidden name=external value="{{.External}}">
        </form>
    {{end}}
<pre>
RelayState: {{.RelayState}}
----
{{.ResponsePP}}
</pre>
<table class=attrValues>
{{range .DebugValues}}
<tr>
<td>{{.Name}}{{if .Must}}*{{end}}</td>
<td>{{range .Values}}{{.}}<br>{{end}}</td>
</tr>
{{end}}
</table>
{{end}}
<script>
getDebug()
host = window.location.host
sp2 = host == 'wayfsp2.wayf.dk'

if (sp2) {
    document.documentElement.style.setProperty('--brand-color', '#B91C1C');
    const title = document.getElementById("title")
    title.innerHTML += " 2"
}
var idpentityID = document.cookie.split(';').filter((item) => item.trim().startsWith('idpentityID='))
if (idpentityID.length) {
    idpentityID = idpentityID[0].split('=')[1]
}
const acs = "acs="
var sp = encodeURIComponent('https://'+host)
const color = encodeURIComponent(getComputedStyle(document.documentElement).getPropertyValue('--brand-color'))
document.querySelector("#mindthegap").innerHTML = `<div class=debug style="justify-content: right; display: flex;"><iframe frameborder="0" src="https://${host}/ds/mindthegap.html?sp=${sp}&lang=da&${acs}&color=${color}" style="width: 350px; height: 100px;"></iframe></div>`

details = document.getElementById("details")
details.hidden = 0
document.getElementById("title").addEventListener("click", function() {
    details.hidden = !details.hidden;
  });
</script>
</body>
</html>
{{ end }}